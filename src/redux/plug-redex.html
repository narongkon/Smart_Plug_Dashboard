<script>
    Nylon.addReducer('plug', function (state, action) {
        state = state || {
            select: {}
        }

        switch (action.type) {
            case 'PLUG_SET_PARAMS':
                state._params = action.payload
                return state
            case 'PLUG_GET_DATA':
                state.data = action.payload
                return state
            case 'PLUG_SELECT_DATA':
                state.select = action.payload
                return state
            case 'PLUG_CLEAR_SELECT':
                state.select = {}
                return state
            default:
                return state
        }
        return state
    })


    Nylon.addAction({

        PLUG_SET_PARAMS: function (data) {
            return dispatch => {
                dispatch({ type: 'PLUG_SET_PARAMS', payload: data })
            }
        },
        PLUG_GET_DATA: function (id) {

            // var progress = Nylon.$['page-plug'].$.list.$.pc1.progress({ position: 'top' })
            return dispatch => {
                var gateway = Nylon.store.getState().plug._params.id;
                axios.get(`/list?gateway=${gateway}`)
                    .then(
                    res => {
                        // progress(() => {
                        dispatch({ type: 'PLUG_GET_DATA', payload: res.data })
                        // })
                    }
                    )
                    .catch(
                    err => {
                        progress(() => {
                            console.log({ err })
                            Nylon.$['page-plug'].$.list.$.pc1.notify({
                                status: 'error',
                                msg: err.response.data.msg,
                                position: 'top'
                            })
                        })
                    }
                    )
            }
        },
        PLUG_INSERT_DATA: function (data) {
            return dispatch => {
                var progress = Nylon.$['page-plug'].$.right.$.pc2.progress()
                axios.post('/list', select).then(
                    res => {
                        Nylon.dispatch('PLUG_GET_DATA')
                        progress(_ => {
                            Nylon.$['page-plug'].$.right.$.pr.close()
                            Nylon.store.dispatch({ type: 'PLUG_CLEAR_SELECT' })

                            Nylon.toast({
                                msg: 'เพิ่มเสร็จสิ้น'
                            })
                        })


                    }
                )
            }
        },
        PLUG_DELETE_DATA: function (id) {
            return dispatch => {
                axios.delete(`/list?id=${id}`).then(
                    res => {
                        Nylon.dispatch('PLUG_GET_DATA')
                    }
                )
            }
        },
        PLUG_SELECT_DATA: function (id) {
            return dispatch => {
                axios.get(`/list?id=${id}`).then(
                    res => {
                        dispatch({ type: 'PLUG_SELECT_DATA', payload: res.data })
                        Nylon.$['page-plug'].$.right.$.pr.open()
                    }
                )
            }
        },
        PLUG_EDIT_DATA: function (select) {
            var progress = Nylon.$['page-plug'].$.right.$.pc2.progress()
            return dispatch => {
                axios.put('/list', select).then(
                    res => {
                        progress(() => {
                            Nylon.dispatch('PLUG_GET_DATA')
                            Nylon.$['page-plug'].$.right.$.pr.close()
                            Nylon.toast({
                                msg: 'แก้ไขเสร็จสิ้น'
                            })
                        })
                    }
                )
            }
        },
        PLUG_EDIT_STATUS: function (data) {
            // var progress = Nylon.$['page-plug'].$.right.$.pc2.progress()
            return dispatch => {
                axios.put('/list', data).then(
                    res => {
                        // setTimeout(function () {
                        //     Nylon.dispatch('PLUG_GET_DATA')
                        // }, 15000);
                        Nylon.toast({
                            msg: 'แก้ไขเสร็จสิ้น'
                        })
                    }
                )
            }
        },
        PLUG_CONNECT: function (data) {
            return dispatch => {
                // console.log('Data', data)
                axios.put('/list/connect', data).then(
                    res => {
                        Nylon.toast({
                            msg: 'แก้ไขเสร็จสิ้น'
                        })
                    }
                )
            }
        },
        SEND_PING_DATA: function () {
            return dispatch => {
                // console.log('Redux');
                // console.log('REDUX PING', Nylon.store.getState().plug._params.id)
                var gateway = Nylon.store.getState().plug._params.id;
                axios.get(`/list/ping?gateway=${gateway}`).then(
                    res => { }
                )
            }
        },
        UPDATE_CONNECT: function (data) {
            return dispatch => {
                // console.log('CCCCC', data);
                // console.log('REDUX PING', Nylon.store.getState().plug._params.id)
                // var gateway = Nylon.store.getState().plug._params.id;
                axios.put(`/list/ping`, data).then(
                    res => {
                        Nylon.dispatch('PLUG_GET_DATA')
                    }
                )
            }
        }
    })

</script>